# -*- coding: utf-8 -*-
# @author: Andrey Pakhomenkov pakhomenkov@yandex.ru
"""–ü–æ–≥–æ–¥–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –±–æ—Ç–∞."""

# from sys import path
import datetime
import subprocess
# import typing as tpn
import requests
import datetime as pdate

import functions as func
import prototype

# pylint: disable=wrong-import-position
# path.insert(0, "./")
# path.insert(0, "d:/Work/projects/")

# import owm
# os.system()

WEATHER_COMMANDS = ["–ø–æ–≥–æ–¥–∞", "–ø–≥", "weather", "wt"]
CHANNEL_LIST_KEY = "meteorolog_chats"  # X
ENABLED_IN_CHATS_KEY = "meteorolog_chats"
HINT = ["–º–µ—Ç–µ–æ", "meteo"]
FIND_CITY_URL = "http://api.openweathermap.org/data/2.5/find"
FORECAST_WEATHER_URL = "http://api.openweathermap.org/data/2.5/forecast"


class CMeteorolog(prototype.CPrototype):
    """–ö–ª–∞—Å—Å –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∞."""

    def __init__(self, pconfig):
        super().__init__()
        self.config = pconfig

    def can_process(self, pchat_title: str, pmessage_text: str) -> bool:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É"""

        if self.is_enabled(pchat_title):
            word_list: list = func.parse_input(pmessage_text)
            return word_list[0] in WEATHER_COMMANDS or word_list[0] in HINT
        return False

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤ –±–∞–∑–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω—É–∂–Ω–æ–º –Ω–∞—Å–µ–ª–µ–Ω–Ω–æ–º –ø—É–Ω–∫—Ç–µ
    def get_city_id(self, pcity_name: str, plang: str = "ru"):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –≥–æ—Ä–æ–¥–∞"""
        city_id: int = 0
        try:

            res = requests.get(FIND_CITY_URL,
                               params={'q': pcity_name, 'type': 'like',
                                       'units': 'metric', 'lang': plang,
                                       'APPID': self.config["api_key"]})
            data = res.json()
            cities = ["{} ({})".format(d['name'], d['sys']['country'])
                      for d in data['list']]
            print("city:", cities)
            city_id = data['list'][0]['id']
            print('city_id=', city_id)
        except Exception as ex:
            print("Exception (find):", ex)
            pass
        assert isinstance(city_id, int)
        return city_id

    def get_help(self) -> str:  # noqa
        """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥."""
        command_list: str = ""
        for command in WEATHER_COMMANDS:
            command_list += command + ", "
        command_list = command_list[:-2]
        command_list += "\n"
        return command_list

    def get_weather(self, picon):
        result: str = ""
        if picon == "01d" or picon == "02d":

            result = "–Ø—Å–Ω–æ. üåû"
        elif picon == "01n" or picon == "02n":

            result = "–Ø—Å–Ω–æ. üåú"
        elif picon == "03d" or \
                picon == "03n" or \
                picon == "04d" or \
                picon == "04n":
            result = "–û–±–ª–∞—á–Ω–æ. ‚òÅ"
        elif picon == "09d" or \
                picon == "09n" or \
                picon == "10d" or \
                picon == "10n":
            result = "–î–æ–∂–¥—å. üåß"
        if picon == "11d" or picon == "11n":
            result = "–ì—Ä–æ–∑–∞. üå©"
        if picon == "13d" or picon == "13n":
            result = "–°–Ω–µ–≥. ‚ùÑ"
        if picon == "50d" or picon == "50n":
            result = "–¢—É–º–∞–Ω.üå´"
        return result

    def get_hint(self, pchat_title: str) -> str:  # [arguments-differ]
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –º–æ–¥—É–ª–µ–º.  """
        assert pchat_title is not None, \
            "Assert: [barman.get_hint] " \
            "No <pchat_title> parameter specified!"

        if self.is_enabled(pchat_title):
            return ", ".join(HINT)
        return ""

    def get_wind_direction(self, pdegree):  # noqa
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞."""
        directions: list = ['—Å–µ–≤. ', '—Å–≤', ' –≤–æ—Å—Ç.', '—é–≤', '—é–≥ ', '—é–∑', ' –∑–∞–ø.', '—Å–∑']
        result: str = ""
        for i in range(0, 8):

            step = 45.
            min_degree = i * step - 45 / 2.
            max_degree = i * step + 45 / 2.
            if i == 0 and pdegree > 360 - 45 / 2.:
                pdegree = pdegree - 360
            if min_degree <= pdegree <= max_degree:
                result = directions[i]
                break
        return result

    def is_enabled(self, pchat_title: str) -> bool:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥ —Ä–∞–∑—Ä–µ—à–µ–Ω –Ω–∞ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ."""

        return pchat_title in self.config[ENABLED_IN_CHATS_KEY]

    def meteorolog(self, pchat_title: str, pmessage_text: str) -> str:
        """–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–∞–∑–±–æ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

        message = ""
        word_list: list = func.parse_input(pmessage_text)
        if self.can_process(pchat_title, pmessage_text):

            # *** –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –º–µ–Ω—é.
            if word_list[0] in HINT:
                message = self.get_help()
            if word_list[0] in WEATHER_COMMANDS:

                if len(word_list) > 1:

                    city_name = word_list[1]
                    city_id = self.get_city_id(city_name)
                    message = self.request_forecast(city_id)
                else:

                    message = "–ö–∞–∫—É—é —Ç–µ–±–µ –µ—â–µ –ø–æ–≥–æ–¥—É?"
        return message

    def reload(self):
        pass

    def request_forecast(self, pcity_id, plang: str = "ru"):
        """–ó–∞–ø—Ä–æ—Å –ø–æ–≥–æ–¥—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞."""
        message: str = ""
        now: datetime.datetime = datetime.datetime.now()
        tomorrow: datetime.datetime = now + pdate.timedelta(days=1)
        min_temperature: int = 100
        max_temperature: int = 0
        min_pressure: int = 10000
        max_pressure: int = 0
        min_humidity: int = 100
        max_humidity: int = 0
        min_wind_speed: int = 200
        max_wind_speed: int = 0
        min_wind_angle: int = 360
        max_wind_angle: int = 0
        weather: list = []
        weather_line: str = ""
        try:

            res = requests.get(FORECAST_WEATHER_URL,
                               params={'id': pcity_id, 'units': 'metric',
                                       'lang': plang, 'APPID': self.config["api_key"]})
            data = res.json()
            for item in data['list']:

                # 1. –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
                data_datetime: datetime.datetime = datetime.datetime.fromtimestamp(item['dt'])
                if data_datetime.date() == tomorrow.date():

                    main = item['main']
                    # *** –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
                    if main["temp"] < min_temperature:
                        min_temperature = main["temp"]
                    if main["temp"] > max_temperature:
                        max_temperature = main["temp"]
                    # *** –î–∞–≤–ª–µ–Ω–∏–µ
                    if main["pressure"] < min_pressure:
                        min_pressure = main["pressure"]
                    if main["pressure"] > max_pressure:
                        max_pressure = main["pressure"]
                    # *** –í–ª–∞–∂–Ω–æ—Å—Ç—å
                    if main["humidity"] < min_humidity:
                        min_humidity = main["humidity"]
                    if main["humidity"] > max_humidity:
                        max_humidity = main["humidity"]
                    wind_speed = item["wind"]["speed"]
                    wind_angle = item["wind"]["deg"]
                    if wind_speed < min_wind_speed:
                        min_wind_speed = wind_speed
                        min_wind_angle = wind_angle
                    if wind_speed > max_wind_speed:
                        max_wind_speed = wind_speed
                        max_wind_angle = wind_angle
                    # print(item)
                    # break
                    # weather = item["weather"][0]
                    #print(icon[:-1])
                    icon = item["weather"][0]["icon"]

                    #print(icon[:-1])
                    #print(icon[0:2])

                    if icon[0:2] != "01":

                        icon = icon[0:2] + "d"
                    if icon[0:2] == "04":

                        icon = "03d"
                    elif icon[0:2] == "10":

                        icon = "09d"

                    if icon not in weather:

                        weather.append(icon)
            print(weather)
            for icon in weather:

                weather_line += self.get_weather(icon) + " "
            message = f"–¢–µ–º–ø.: {round(min_temperature)} - {round(max_temperature)} ¬∞C, " \
                      f" –¥–∞–≤–ª.: {round(min_pressure * 0.75)} - {round(max_pressure * 0.75)} –º–º.—Ä—Ç.—Å—Ç., " \
                      f" –≤–ª–∞–∂–Ω.: {round(min_humidity)} - {round(max_humidity)} %, " \
                      f" –≤–µ—Ç–µ—Ä: {round(min_wind_speed)} –º/—Å {self.get_wind_direction(min_wind_angle)} " \
                      f"- {round(max_wind_speed)} –º/c {self.get_wind_direction(max_wind_angle)}, " \
                      f" {weather_line}"


        except Exception as ex:

            print("Exception (forecast):", ex)
        return message
